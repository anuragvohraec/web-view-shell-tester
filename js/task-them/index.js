var e=function(){return(e=Object.assign||function(e){for(var t,a=1,n=arguments.length;a<n;a++)for(var r in t=arguments[a])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e}).apply(this,arguments)};function t(e,t,a,n){return new(a||(a=Promise))((function(r,s){function i(e){try{u(n.next(e))}catch(e){s(e)}}function o(e){try{u(n.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof a?t:new a((function(e){e(t)}))).then(i,o)}u((n=n.apply(e,t||[])).next())}))}function a(e,t){var a,n,r,s,i={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return s={next:o(0),throw:o(1),return:o(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function o(s){return function(o){return function(s){if(a)throw new TypeError("Generator is already executing.");for(;i;)try{if(a=1,n&&(r=2&s[0]?n.return:s[0]?n.throw||((r=n.return)&&r.call(n),0):n.next)&&!(r=r.call(n,s[1])).done)return r;switch(n=0,r&&(s=[2&s[0],r.value]),s[0]){case 0:case 1:r=s;break;case 4:return i.label++,{value:s[1],done:!1};case 5:i.label++,n=s[1],s=[0];continue;case 7:s=i.ops.pop(),i.trys.pop();continue;default:if(!(r=i.trys,(r=r.length>0&&r[r.length-1])||6!==s[0]&&2!==s[0])){i=0;continue}if(3===s[0]&&(!r||s[1]>r[0]&&s[1]<r[3])){i.label=s[1];break}if(6===s[0]&&i.label<r[1]){i.label=r[1],r=s;break}if(r&&i.label<r[2]){i.label=r[2],i.ops.push(s);break}r[2]&&i.ops.pop(),i.trys.pop();continue}s=t.call(e,i)}catch(e){s=[6,e],n=0}finally{a=r=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,o])}}}var n,r,s=new Set(["COMPLETED","FAILED"]);!function(e){e.INIT_WEBWORKER="INIT_WEBWORKER",e.CHANGE_TASK_STATE="CHANGE_TASK_STATE",e.CHANGE_TASK_PHASE="CHANGE_TASK_PHASE",e.CREATE_TASK="CREATE_TASK",e.RUN_A_TASK="RUN_A_TASK",e.GET_TASK_STATUS="GET_TASK_STATUS",e.CLEAR_TASK_THEM="CLEAR_TASK_THEM"}(n||(n={})),function(e){e.RUN_TASK="RUN_TASK",e.TASK_STATUS="TASK_STATUS",e.CLEAR_TASK_THEM="CLEAR_TASK_THEM",e.PHASE_CHANGE="PHASE_CHANGE"}(r||(r={}));var i=function(e){return function(e){for(var t,a="0123456789ABCDEF",n="",r=0;r<e.length;r++)t=e.charCodeAt(r),n+=a.charAt(t>>>4&15)+a.charAt(15&t);return n}(function(e){for(var t="",a=0;a<32*e.length;a+=8)t+=String.fromCharCode(e[a>>5]>>>a%32&255);return t}(function(e,t){e[t>>5]|=128<<t%32,e[14+(t+64>>>9<<4)]=t;for(var a=1732584193,n=-271733879,r=-1732584194,s=271733878,i=0;i<e.length;i+=16){var o=a,d=n,T=r,f=s;n=l(n=l(n=l(n=l(n=h(n=h(n=h(n=h(n=c(n=c(n=c(n=c(n=u(n=u(n=u(n=u(n,r=u(r,s=u(s,a=u(a,n,r,s,e[i+0],7,-680876936),n,r,e[i+1],12,-389564586),a,n,e[i+2],17,606105819),s,a,e[i+3],22,-1044525330),r=u(r,s=u(s,a=u(a,n,r,s,e[i+4],7,-176418897),n,r,e[i+5],12,1200080426),a,n,e[i+6],17,-1473231341),s,a,e[i+7],22,-45705983),r=u(r,s=u(s,a=u(a,n,r,s,e[i+8],7,1770035416),n,r,e[i+9],12,-1958414417),a,n,e[i+10],17,-42063),s,a,e[i+11],22,-1990404162),r=u(r,s=u(s,a=u(a,n,r,s,e[i+12],7,1804603682),n,r,e[i+13],12,-40341101),a,n,e[i+14],17,-1502002290),s,a,e[i+15],22,1236535329),r=c(r,s=c(s,a=c(a,n,r,s,e[i+1],5,-165796510),n,r,e[i+6],9,-1069501632),a,n,e[i+11],14,643717713),s,a,e[i+0],20,-373897302),r=c(r,s=c(s,a=c(a,n,r,s,e[i+5],5,-701558691),n,r,e[i+10],9,38016083),a,n,e[i+15],14,-660478335),s,a,e[i+4],20,-405537848),r=c(r,s=c(s,a=c(a,n,r,s,e[i+9],5,568446438),n,r,e[i+14],9,-1019803690),a,n,e[i+3],14,-187363961),s,a,e[i+8],20,1163531501),r=c(r,s=c(s,a=c(a,n,r,s,e[i+13],5,-1444681467),n,r,e[i+2],9,-51403784),a,n,e[i+7],14,1735328473),s,a,e[i+12],20,-1926607734),r=h(r,s=h(s,a=h(a,n,r,s,e[i+5],4,-378558),n,r,e[i+8],11,-2022574463),a,n,e[i+11],16,1839030562),s,a,e[i+14],23,-35309556),r=h(r,s=h(s,a=h(a,n,r,s,e[i+1],4,-1530992060),n,r,e[i+4],11,1272893353),a,n,e[i+7],16,-155497632),s,a,e[i+10],23,-1094730640),r=h(r,s=h(s,a=h(a,n,r,s,e[i+13],4,681279174),n,r,e[i+0],11,-358537222),a,n,e[i+3],16,-722521979),s,a,e[i+6],23,76029189),r=h(r,s=h(s,a=h(a,n,r,s,e[i+9],4,-640364487),n,r,e[i+12],11,-421815835),a,n,e[i+15],16,530742520),s,a,e[i+2],23,-995338651),r=l(r,s=l(s,a=l(a,n,r,s,e[i+0],6,-198630844),n,r,e[i+7],10,1126891415),a,n,e[i+14],15,-1416354905),s,a,e[i+5],21,-57434055),r=l(r,s=l(s,a=l(a,n,r,s,e[i+12],6,1700485571),n,r,e[i+3],10,-1894986606),a,n,e[i+10],15,-1051523),s,a,e[i+1],21,-2054922799),r=l(r,s=l(s,a=l(a,n,r,s,e[i+8],6,1873313359),n,r,e[i+15],10,-30611744),a,n,e[i+6],15,-1560198380),s,a,e[i+13],21,1309151649),r=l(r,s=l(s,a=l(a,n,r,s,e[i+4],6,-145523070),n,r,e[i+11],10,-1120210379),a,n,e[i+2],15,718787259),s,a,e[i+9],21,-343485551),a=_(a,o),n=_(n,d),r=_(r,T),s=_(s,f)}return Array(a,n,r,s)}(function(e){for(var t=Array(e.length>>2),a=0;a<t.length;a++)t[a]=0;for(a=0;a<8*e.length;a+=8)t[a>>5]|=(255&e.charCodeAt(a/8))<<a%32;return t}(e),8*e.length))).toLowerCase()};function o(e,t,a,n,r,s){return _(function(e,t){return e<<t|e>>>32-t}(_(_(t,e),_(n,s)),r),a)}function u(e,t,a,n,r,s,i){return o(t&a|~t&n,e,t,r,s,i)}function c(e,t,a,n,r,s,i){return o(t&n|a&~n,e,t,r,s,i)}function h(e,t,a,n,r,s,i){return o(t^a^n,e,t,r,s,i)}function l(e,t,a,n,r,s,i){return o(a^(t|~n),e,t,r,s,i)}function _(e,t){var a=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(a>>16)<<16|65535&a}var d=function(){function e(){}return e.random_string=function(e){for(var t="",a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*()_+",n=a.length,r=0;r<e;r++)t+=a.charAt(Math.floor(Math.random()*n));return t},e.getuuid=function(){var e={date:(new Date).getTime(),rand:this.random_string(5)};return i(JSON.stringify(e))},e.md5=i,e}(),T=function(){function i(){}return i.registerTaskClass=function(e,t,a){t||(t=e.name),this.taskRegistry[t]=e,t&&a&&(this.taskActionOnPhaseChangeReg[t]=a)},i.init=function(i,o){var u=this;void 0===i&&(i="task-runner-ww.js"),void 0===o&&(o=-1),this.initCalled||(this.worker=new Worker(i),this.worker.onmessage=function(n){return t(u,void 0,void 0,(function(){var t,i,o,u,c;return a(this,(function(a){switch(a.label){case 0:switch(n.data.type){case r.PHASE_CHANGE:return[3,1];case r.RUN_TASK:return[3,2];case r.TASK_STATUS:return[3,11];case r.CLEAR_TASK_THEM:return[3,12]}return[3,14];case 1:c=n.data.data;try{null==(t=this.taskActionOnPhaseChangeReg[c.task_name])||t(c)}catch(e){console.error("[TASK-THEM] throws error in actionOnPhaseChange function")}return[3,14];case 2:c=n.data.data,i=c.task_name,this.activeTask[c._id]=e({},c),delete this.pausedTask[c._id],a.label=3;case 3:return a.trys.push([3,8,,10]),this.taskRegistry[i]?[3,4]:(console.warn("No such tasks!: "+i),[3,7]);case 4:return[4,Reflect.construct(this.taskRegistry[i],[])._execute(c._id,c.task_name,c.task_desc,c.state,c.phase,c.phase_data)];case 5:return o=a.sent(),s.has(o)?delete this.activeTask[c._id]:this.pausedTask[c._id]=e(e({},c),{state:o}),[4,this.change_task_state(c._id,o)];case 6:a.sent(),a.label=7;case 7:return[3,10];case 8:return u=a.sent(),console.warn("Very bad Task "+i+"! Your must catch all your exception in your run method!"),console.error(u),[4,this.change_task_state(c._id,"FAILED")];case 9:return[2,a.sent()];case 10:return[3,14];case 11:return c=n.data.data,this.getTaskStatusMap[c._id](c),[3,14];case 12:return[4,this.taskThemClearResolverFunc(n.data.data)];case 13:a.sent(),this.taskThemClearResolverFunc=void 0,a.label=14;case 14:return[2]}}))}))},this.worker.postMessage({type:n.INIT_WEBWORKER,archive_ended_task_before:o}),this.initCalled=!0)},Object.defineProperty(i,"activeTasks",{get:function(){return this.activeTask},enumerable:!1,configurable:!0}),Object.defineProperty(i,"pausedTasks",{get:function(){return this.pausedTask},enumerable:!1,configurable:!0}),i.isTaskActive=function(e){return!!this.activeTask[e]},i.isTaskPaused=function(e){return!!this.pausedTask[e]},i.hasTaskEnded=function(e){return!this.isTaskActive(e)&&!this.isTaskPaused(e)},i.runAPausedTask=function(e,t){this.pausedTask[e]&&(t&&(this.changeHandlerRegistry[e]=t),this.worker.postMessage({type:n.RUN_A_TASK,data:{task_id:e}}))},i.getTaskStatus=function(e){var t=this;return new Promise((function(a){t.worker.postMessage({type:n.GET_TASK_STATUS,data:{task_id:e}}),t.getTaskStatusMap[e]=a}))},i.clearTaskThem=function(e){var t=this;return void 0===e&&(e=!1),this.activeTask={},this.pausedTask={},e&&(this.taskRegistry={}),new Promise((function(e){t.taskThemClearResolverFunc=e,t.worker.postMessage({type:n.CLEAR_TASK_THEM})}))},i.change_task_state=function(e,r){return t(this,void 0,void 0,(function(){var t,s;return a(this,(function(a){switch(a.label){case 0:this.worker.postMessage({type:n.CHANGE_TASK_STATE,data:{task_id:e,state:r}}),a.label=1;case 1:return a.trys.push([1,4,,5]),(t=this.changeHandlerRegistry[e])?[4,t(r,e)]:[3,3];case 2:a.sent(),this.remove_stateChangeHandler(e),a.label=3;case 3:return[3,5];case 4:return s=a.sent(),console.warn("Very bad!, your TaskStateChangeHandler for task_id:"+e+" do not catches its errors!"),console.error(s),[3,5];case 5:return[2]}}))}))},i.change_task_phase=function(e,t,a){this.worker.postMessage({type:n.CHANGE_TASK_PHASE,data:{task_id:e,phase:t,phase_data:a}})},i.create_task=function(e){var r;return t(this,void 0,void 0,(function(){var t,s,i;return a(this,(function(a){switch(a.label){case 0:if(!(t=this.taskRegistry[e.task_name]))throw"No such task registered with TaskManager. You must register task classes to use them!";return[4,d.getuuid()];case 1:return s=a.sent(),i=null!==(r=e.run_time_behavior)&&void 0!==r?r:t.behavior,e.stateChangeHandler&&(this.changeHandlerRegistry[s]=e.stateChangeHandler),this.worker.postMessage({type:n.CREATE_TASK,data:{_id:s,task_name:e.task_name,task_desc:e.task_desc,init_phase:e.init_phase,init_phase_data:e.init_phase_data,behaves:i}}),[2,s]}}))}))},i.remove_stateChangeHandler=function(e){delete this.changeHandlerRegistry[e]},i.taskRegistry={},i.taskActionOnPhaseChangeReg={},i.initCalled=!1,i.changeHandlerRegistry={},i.activeTask={},i.pausedTask={},i.getTaskStatusMap={},i}(),f=function(){function e(){}return Object.defineProperty(e,"behavior",{get:function(){return this.behaves},enumerable:!1,configurable:!0}),e.prototype._execute=function(e,t,a,n,r,s){return this._id=e,this.run(t,a,n,r,s)},e.prototype.record_phase_change=function(e,t){T.change_task_phase(this._id,e,t)},e.behaves="WILL_QUEUE",e}();export{f as Task,T as TaskManager};
